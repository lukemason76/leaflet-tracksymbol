/*! leaflet-tracksymbol 2016-02-19 Copyright by   */
L.TrackSymbol=L.Path.extend({initialize:function(a,b){if(L.Path.prototype.initialize.call(this,b),void 0===a)throw Error("Please give a valid lat/lon-position");b=b||{},this._id=b.trackId||0,this._leaflet_id=this._id,this._latlng=L.latLng(a),this._size=b.size||24,this._heading=b.heading,this._course=b.course,this._speed=b.speed,this._leaderTime=b.leaderTime||60,this._minSilouetteZoom=b.minSilouetteZoom||14,this.setGPSRefPos(b.gpsRefPos),this._triSymbol=b.defaultSymbol||[.75,0,-.25,.3,-.25,-.3],this._diaSymbol=b.noHeadingSymbol||[.3,0,0,.3,-.3,0,0,-.3],this._silSymbol=b.silouetteSymbol||[1,.5,.75,1,0,1,0,0,.75,0]},setLatLng:function(a){return this._latlng=L.latLng(a),this.redraw()},setSpeed:function(a){return this._speed=a,this.redraw()},setCourse:function(a){return this._course=a,this.redraw()},setHeading:function(a){return this._heading=a,this.redraw()},setLeaderTime:function(a){return this._leaderTime=a,this.redraw()},setGPSRefPos:function(a){return void 0===a||a.length<4?this._gpsRefPos=void 0:0===a[0]&&0===a[1]&&0===a[2]&&0===a[3]?this._gpsRefPos=void 0:this._gpsRefPos=a,this.redraw()},getTrackId:function(){return this._id},_getLatSize:function(){return this._getLatSizeOf(this._size)},_getLngSize:function(){return this._getLngSizeOf(this._size)},_getLatSizeOf:function(a){return a/40075017*360},_getLngSizeOf:function(a){return a/40075017*360/Math.cos(L.LatLng.DEG_TO_RAD*this._latlng.lat)},getBounds:function(){var a=this._getLngSize()/2,b=this._getLatSize()/2,c=this._latlng;return new L.LatLngBounds([c.lat-b,c.lng-a],[c.lat+b,c.lng+a])},getLatLng:function(){return this._latlng},_rotate:function(a,b){var c=a[0],d=a[1],e=Math.sin(b),f=Math.cos(b),g=c*f-d*e,h=c*e+d*f;return[g,h]},_rotateAllPoints:function(a,b){for(var c=[],d=0;d<a.length;d+=2){var e=a[d+0]*this._size,f=a[d+1]*this._size,g=this._rotate([e,f],b);c.push(g[0]),c.push(g[1])}return c},_createLeaderViewPoints:function(a){var b=this._speed*this._leaderTime,c=this._latlng.lng+this._getLngSizeOf(b*Math.cos(a)),d=this._latlng.lat+this._getLatSizeOf(b*Math.sin(a)),e=this._map.latLngToLayerPoint(L.latLng([d,c])),f=this._map.latLngToLayerPoint(this._latlng);return[f.x,f.y,e.x,e.y]},_transformAllPointsToView:function(a){for(var b=[],c=this._map.latLngToLayerPoint(this._latlng),d=0;d<a.length;d+=2){var e=c.x+a[d+0],f=c.y-a[d+1];b.push(e),b.push(f)}return b},_createPathFromPoints:function(a){for(var b,c=0;c<a.length;c+=2){var d=a[c+0],e=a[c+1];void 0===b?b="M "+d+" "+e+" ":b+="L "+d+" "+e+" "}return b+" Z"},_getViewAngleFromModel:function(a){return Math.PI/2-a},_createNoHeadingSymbolPathString:function(){var a=this._transformAllPointsToView(this._rotateAllPoints(this._diaSymbol,0)),b=this._createPathFromPoints(a);if(void 0!==this._course&&void 0!==this._speed){var c=this._getViewAngleFromModel(this._course),d=this._createLeaderViewPoints(c);b+=""+this._createPathFromPoints(d)}return b},_createWithHeadingSymbolPathString:function(){var a=this._getViewAngleFromModel(this._heading),b=this._transformAllPointsToView(this._rotateAllPoints(this._triSymbol,a)),c=this._createPathFromPoints(b);if(void 0!==this._course&&void 0!==this._speed){var d=this._getViewAngleFromModel(this._course),e=this._createLeaderViewPoints(d);c+=""+this._createPathFromPoints(e)}return c},_resizeAndMovePoint:function(a,b,c){return[a[0]*b[0]+c[0],a[1]*b[1]+c[1]]},_getSizeFromGPSRefPos:function(){return[this._gpsRefPos[0]+this._gpsRefPos[1],this._gpsRefPos[2]+this._gpsRefPos[3]]},_getOffsetFromGPSRefPos:function(){return[-this._gpsRefPos[1],-this._gpsRefPos[3]]},_transformSilouetteSymbol:function(){for(var a=this._getViewAngleFromModel(this._heading),b=[],c=this._getSizeFromGPSRefPos(),d=this._getOffsetFromGPSRefPos(),e=0;e<this._silSymbol.length;e+=2){var f=[this._silSymbol[e+0],this._silSymbol[e+1]];f=this._resizeAndMovePoint(f,c,d),f=this._rotate(f,a);var g=this._latlng.lng+this._getLngSizeOf(f[0]),h=this._latlng.lat+this._getLatSizeOf(f[1]),i=this._map.latLngToLayerPoint(L.latLng([h,g]));b.push(i.x),b.push(i.y)}return b},_createSilouetteSymbolPathString:function(){var a=this._transformSilouetteSymbol(),b=this._createPathFromPoints(a);if(void 0!==this._course&&void 0!==this._speed){var c=this._getViewAngleFromModel(this._course),d=this._createLeaderViewPoints(c);b+=""+this._createPathFromPoints(d)}return b},getPathString:function(){return void 0===this._heading?this._createNoHeadingSymbolPathString():void 0===this._gpsRefPos||this._map.getZoom()<=this._minSilouetteZoom?this._createWithHeadingSymbolPathString():this._createSilouetteSymbolPathString()}}),L.trackSymbol=function(a,b){return new L.TrackSymbol(a,b)};